/**
 * Document Generator Module
 * Generates Markdown, HTML, and JSON documentation from parsed TMDL model
 */

class DocGenerator {
    /**
     * @param {Object} model - Parsed TMDL model from TMDLParser
     * @param {Object} visualUsage - Visual usage data from VisualParser (optional)
     * @param {Object} measureRefs - DAX reference data (optional)
     */
    constructor(model, visualUsage, measureRefs, lineageEngine) {
        this.model = model;
        this.visualUsage = visualUsage || {};
        this.measureRefs = measureRefs || {};
        this.lineageEngine = lineageEngine || null;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // MARKDOWN
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    generateMarkdown(scope = 'all', visualData = null) {
        if (scope === 'model') return this._generateMarkdownModel();
        if (scope === 'visuals') return this._generateMarkdownVisuals(visualData);
        return this._generateMarkdownAll(visualData);
    }

    _generateMarkdownAll(visualData) {
        const lines = [];
        const modelName = this.model.database?.name || this.model.model?.name || 'Semantic Model';

        lines.push(`# ${modelName} ‚Äî Full Documentation`);
        lines.push('');
        lines.push(`*Generated by [pbip-documenter](https://github.com/JonathanJihwanKim/pbip-documenter) on ${new Date().toLocaleDateString()}*`);
        lines.push(`*If this tool saved you time: [Sponsor](https://github.com/sponsors/JonathanJihwanKim?o=doc) | [Buy Me a Coffee](https://buymeacoffee.com/jihwankim?o=doc)*`);
        lines.push('');

        // Table of Contents
        lines.push('## Table of Contents');
        lines.push('');
        lines.push('- [Model Overview](#model-overview)');
        lines.push('- [Table Inventory](#table-inventory)');

        for (const table of this.model.tables) {
            const anchor = table.name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            lines.push(`  - [${table.name}](#${anchor})`);
        }

        lines.push('- [Measure Catalog](#measure-catalog)');
        lines.push('- [Relationships](#relationships)');

        if (this.model.roles.length > 0) {
            lines.push('- [Roles](#roles)');
        }
        if (this.model.expressions.length > 0) {
            lines.push('- [Expressions](#expressions)');
        }
        if (visualData && visualData.pages.length > 0) {
            lines.push('- [Report Pages & Visual Layout](#report-pages--visual-layout)');
        }
        if (Object.keys(this.visualUsage).length > 0) {
            lines.push('- [Visual Usage](#visual-usage)');
        }
        if (this.lineageEngine) {
            const ds = this.lineageEngine.getAllDataSources();
            if (ds.length > 0) lines.push('- [Data Sources](#data-sources)');
            lines.push('- [Measure Dependencies](#measure-dependencies)');
            if (visualData && visualData.visuals && visualData.visuals.length > 0) {
                lines.push('- [Visual Lineage Summary](#visual-lineage-summary)');
            }
        }

        lines.push('');

        // Model sections
        this._appendMarkdownModelSections(lines);

        // Report Pages & Visual Layout
        if (visualData && visualData.pages.length > 0) {
            this._appendMarkdownVisualSections(lines, visualData);
        }

        // Visual Usage Summary
        if (Object.keys(this.visualUsage).length > 0) {
            this._appendMarkdownVisualUsageSummary(lines);
        }

        // Data Lineage sections
        this._appendMarkdownLineageSections(lines, visualData);

        // Footer
        lines.push('---');
        lines.push(`*Generated with [pbip-documenter](https://github.com/JonathanJihwanKim/pbip-documenter) ‚Äî free, open-source TMDL documentation with visual lineage.*`);
        lines.push(`*Support: [Sponsor](https://github.com/sponsors/JonathanJihwanKim?o=doc) | [Buy Me a Coffee](https://buymeacoffee.com/jihwankim?o=doc)*`);

        return lines.join('\n');
    }

    _generateMarkdownModel() {
        const lines = [];
        const modelName = this.model.database?.name || this.model.model?.name || 'Semantic Model';

        lines.push(`# ${modelName} ‚Äî Semantic Model Documentation`);
        lines.push('');
        lines.push(`*Generated by [pbip-documenter](https://github.com/JonathanJihwanKim/pbip-documenter) on ${new Date().toLocaleDateString()}*`);
        lines.push(`*If this tool saved you time: [Sponsor](https://github.com/sponsors/JonathanJihwanKim?o=doc) | [Buy Me a Coffee](https://buymeacoffee.com/jihwankim?o=doc)*`);
        lines.push('');

        // Table of Contents
        lines.push('## Table of Contents');
        lines.push('');
        lines.push('- [Model Overview](#model-overview)');
        lines.push('- [Table Inventory](#table-inventory)');
        for (const table of this.model.tables) {
            const anchor = table.name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            lines.push(`  - [${table.name}](#${anchor})`);
        }
        lines.push('- [Measure Catalog](#measure-catalog)');
        lines.push('- [Relationships](#relationships)');
        if (this.model.roles.length > 0) lines.push('- [Roles](#roles)');
        if (this.model.expressions.length > 0) lines.push('- [Expressions](#expressions)');
        lines.push('');

        // Model sections (no visual usage per measure)
        this._appendMarkdownModelSections(lines, false);

        // Footer
        lines.push('---');
        lines.push(`*Generated with [pbip-documenter](https://github.com/JonathanJihwanKim/pbip-documenter) ‚Äî free, open-source TMDL documentation.*`);
        lines.push(`*Support: [Sponsor](https://github.com/sponsors/JonathanJihwanKim?o=doc) | [Buy Me a Coffee](https://buymeacoffee.com/jihwankim?o=doc)*`);

        return lines.join('\n');
    }

    _generateMarkdownVisuals(visualData) {
        const lines = [];
        const modelName = this.model.database?.name || this.model.model?.name || 'Semantic Model';

        lines.push(`# ${modelName} ‚Äî Visual Documentation`);
        lines.push('');
        lines.push(`*Generated by [pbip-documenter](https://github.com/JonathanJihwanKim/pbip-documenter) on ${new Date().toLocaleDateString()}*`);
        lines.push(`*If this tool saved you time: [Sponsor](https://github.com/sponsors/JonathanJihwanKim?o=doc) | [Buy Me a Coffee](https://buymeacoffee.com/jihwankim?o=doc)*`);
        lines.push('');

        if (!visualData || visualData.pages.length === 0) {
            lines.push('*No report visual data available.*');
            lines.push('');
            lines.push('---');
            lines.push(`*Generated with [pbip-documenter](https://github.com/JonathanJihwanKim/pbip-documenter)*`);
            return lines.join('\n');
        }

        // Summary
        lines.push('## Report Summary');
        lines.push('');
        lines.push('| Property | Value |');
        lines.push('|----------|-------|');
        lines.push(`| Pages | ${visualData.pages.length} |`);
        lines.push(`| Total Visuals | ${visualData.visuals.length} |`);
        lines.push('');

        // Pages & Visual Layout
        this._appendMarkdownVisualSections(lines, visualData);

        // Visual Usage Cross-Reference
        if (Object.keys(this.visualUsage).length > 0) {
            this._appendMarkdownVisualUsageSummary(lines);
        }

        // Footer
        lines.push('---');
        lines.push(`*Generated with [pbip-documenter](https://github.com/JonathanJihwanKim/pbip-documenter) ‚Äî free, open-source TMDL documentation.*`);
        lines.push(`*Support: [Sponsor](https://github.com/sponsors/JonathanJihwanKim?o=doc) | [Buy Me a Coffee](https://buymeacoffee.com/jihwankim?o=doc)*`);

        return lines.join('\n');
    }

    /**
     * Append model sections (overview, tables, measures, relationships, roles, expressions)
     * @param {boolean} includeVisualUsage - Whether to include visual usage per measure
     */
    _appendMarkdownModelSections(lines, includeVisualUsage = true) {
        // Model Overview
        lines.push('## Model Overview');
        lines.push('');
        lines.push('| Property | Value |');
        lines.push('|----------|-------|');

        if (this.model.database?.name) {
            lines.push(`| Database | ${this.model.database.name} |`);
        }
        if (this.model.database?.compatibilityLevel) {
            lines.push(`| Compatibility Level | ${this.model.database.compatibilityLevel} |`);
        }
        if (this.model.model?.culture) {
            lines.push(`| Culture | ${this.model.model.culture} |`);
        }

        const totalMeasures = this.model.tables.reduce((sum, t) => sum + t.measures.length, 0);
        const totalColumns = this.model.tables.reduce((sum, t) => sum + t.columns.length, 0);

        lines.push(`| Tables | ${this.model.tables.length} |`);
        lines.push(`| Columns | ${totalColumns} |`);
        lines.push(`| Measures | ${totalMeasures} |`);
        lines.push(`| Relationships | ${this.model.relationships.length} |`);
        lines.push(`| Roles | ${this.model.roles.length} |`);
        lines.push('');

        // Table Inventory
        lines.push('## Table Inventory');
        lines.push('');

        for (const table of this.model.tables) {
            lines.push(`### ${table.name}`);
            lines.push('');

            if (table.description) {
                lines.push(`> ${table.description}`);
                lines.push('');
            }

            if (table.isHidden) {
                lines.push('*Hidden table*');
                lines.push('');
            }

            // Field parameter detection
            const fpItems = this._getFieldParameterItems(table.name);
            if (fpItems !== null) {
                lines.push('**Field Parameter** ‚Äî This table is a dynamic field selector.');
                lines.push('');
                if (fpItems.length > 0) {
                    lines.push('Available fields:');
                    for (const item of fpItems) {
                        lines.push(`- \`'${item.table}'[${item.column}]\``);
                    }
                    lines.push('');
                }
            }

            // Calculation Group
            if (table.calculationGroup && table.calculationGroup.items.length > 0) {
                lines.push(`#### Calculation Group (${table.calculationGroup.items.length} items)`);
                lines.push('');
                for (const item of table.calculationGroup.items) {
                    lines.push(`##### ${this._escMd(item.name)}`);
                    lines.push('');
                    if (item.expression) {
                        lines.push('```dax');
                        lines.push(item.expression);
                        lines.push('```');
                        lines.push('');
                    }
                }
            }

            // Columns
            if (table.columns.length > 0) {
                lines.push('#### Columns');
                lines.push('');
                lines.push('| Column | Data Type | Description | Hidden | Format |');
                lines.push('|--------|-----------|-------------|--------|--------|');

                for (const col of table.columns) {
                    const hidden = col.isHidden ? 'Yes' : '';
                    const desc = col.description || '';
                    const fmt = col.formatString || '';
                    lines.push(`| ${this._escMd(col.name)} | ${col.dataType || ''} | ${this._escMd(desc)} | ${hidden} | ${this._escMd(fmt)} |`);
                }
                lines.push('');
            }

            // Measures
            if (table.measures.length > 0) {
                lines.push('#### Measures');
                lines.push('');

                for (const measure of table.measures) {
                    lines.push(`##### ${this._escMd(measure.name)}`);
                    lines.push('');

                    if (measure.description) {
                        lines.push(`> ${this._escMd(measure.description)}`);
                        lines.push('');
                    }

                    if (measure.displayFolder) {
                        lines.push(`**Display Folder:** ${measure.displayFolder}`);
                        lines.push('');
                    }

                    if (measure.formatString) {
                        lines.push(`**Format:** ${this._escMd(measure.formatString)}`);
                        lines.push('');
                    }

                    if (measure.expression) {
                        lines.push('```dax');
                        lines.push(measure.expression);
                        lines.push('```');
                        lines.push('');
                    }

                    // DAX references
                    const refs = this.measureRefs[measure.name];
                    if (refs) {
                        if (refs.columnRefs.length > 0) {
                            lines.push('**Referenced columns:** ' + refs.columnRefs.map(r => `\`${r.table}[${r.column}]\``).join(', '));
                            lines.push('');
                        }
                        if (refs.measureRefs.length > 0) {
                            lines.push('**Referenced measures:** ' + refs.measureRefs.map(r => `\`[${r}]\``).join(', '));
                            lines.push('');
                        }
                    }

                    // Visual usage (only in 'all' scope)
                    if (includeVisualUsage) {
                        const usageKey = `measure|${table.name}|${measure.name}`;
                        const usage = this.visualUsage[usageKey];
                        if (usage && usage.length > 0) {
                            lines.push('**Used in visuals:**');
                            const byPage = this._groupByPage(usage);
                            for (const [page, visuals] of Object.entries(byPage)) {
                                lines.push(`- *${page}*: ${visuals.map(v => v.visualName).join(', ')}`);
                            }
                            lines.push('');
                        }
                    }
                }
            }

            // Hierarchies
            if (table.hierarchies.length > 0) {
                lines.push('#### Hierarchies');
                lines.push('');
                for (const h of table.hierarchies) {
                    lines.push(`- **${h.name}**: ${h.levels.map(l => l.name || l.column).join(' ‚Üí ')}`);
                }
                lines.push('');
            }

            // Partitions
            if (table.partitions.length > 0) {
                lines.push('#### Partitions');
                lines.push('');
                for (const p of table.partitions) {
                    lines.push(`- **${p.name}** (mode: ${p.mode || 'default'})`);
                }
                lines.push('');
            }
        }

        // Measure Catalog (flat list)
        lines.push('## Measure Catalog');
        lines.push('');
        lines.push('| # | Measure | Table | Display Folder | Format | Description |');
        lines.push('|---|---------|-------|----------------|--------|-------------|');

        let measureNum = 0;
        for (const table of this.model.tables) {
            for (const m of table.measures) {
                measureNum++;
                lines.push(`| ${measureNum} | ${this._escMd(m.name)} | ${table.name} | ${m.displayFolder || ''} | ${this._escMd(m.formatString || '')} | ${this._escMd(m.description || '')} |`);
            }
        }
        lines.push('');

        // Relationships
        lines.push('## Relationships');
        lines.push('');

        if (this.model.relationships.length > 0) {
            lines.push('| From | ‚Üí | To | Cardinality | Cross-Filter | Active |');
            lines.push('|------|---|-----|-------------|--------------|--------|');

            for (const r of this.model.relationships) {
                const from = `${r.fromTable}[${r.fromColumn}]`;
                const to = `${r.toTable}[${r.toColumn}]`;
                const card = this._formatCardinality(r);
                const crossFilter = r.crossFilteringBehavior || 'single';
                const active = r.isActive ? 'Yes' : 'No';
                lines.push(`| ${from} | ‚Üí | ${to} | ${card} | ${crossFilter} | ${active} |`);
            }
        } else {
            lines.push('*No relationships defined.*');
        }
        lines.push('');

        // Roles
        if (this.model.roles.length > 0) {
            lines.push('## Roles');
            lines.push('');

            for (const role of this.model.roles) {
                lines.push(`### ${role.name}`);
                lines.push('');

                if (role.modelPermission) {
                    lines.push(`**Permission:** ${role.modelPermission}`);
                    lines.push('');
                }

                if (role.tablePermissions.length > 0) {
                    lines.push('| Table | Filter Expression |');
                    lines.push('|-------|-------------------|');
                    for (const tp of role.tablePermissions) {
                        lines.push(`| ${tp.table} | \`${this._escMd(tp.filterExpression || '')}\` |`);
                    }
                    lines.push('');
                }
            }
        }

        // Expressions
        if (this.model.expressions.length > 0) {
            lines.push('## Expressions');
            lines.push('');

            for (const expr of this.model.expressions) {
                lines.push(`### ${expr.name}`);
                if (expr.kind) lines.push(`**Kind:** ${expr.kind}`);
                lines.push('');
                if (expr.expression) {
                    lines.push('```m');
                    lines.push(expr.expression);
                    lines.push('```');
                    lines.push('');
                }
            }
        }
    }

    /**
     * Append visual/report page sections to markdown.
     * Includes ASCII layout diagrams per page and field param / calc group annotations.
     */
    _appendMarkdownVisualSections(lines, visualData) {
        lines.push('## Report Pages & Visual Layout');
        lines.push('');

        for (const page of visualData.pages) {
            lines.push(`### ${this._escMd(page.displayName)}`);
            lines.push('');
            lines.push(`*${page.visuals.length} visual(s)${page.pageWidth ? ` \u2014 ${page.pageWidth}\u00d7${page.pageHeight}` : ''}*`);
            lines.push('');

            if (page.visuals.length === 0) {
                lines.push('*No visuals on this page.*');
                lines.push('');
                continue;
            }

            // ASCII layout diagram
            const asciiLayout = this._renderAsciiLayout(page);
            if (asciiLayout) {
                lines.push(asciiLayout);
                lines.push('');
            }

            for (const visual of page.visuals) {
                const vName = visual.visualName || visual.visualType || 'Visual';
                lines.push(`#### ${this._escMd(vName)} (\`${visual.visualType || 'unknown'}\`)`);
                lines.push('');

                if (visual.fields && visual.fields.length > 0) {
                    lines.push('| Role | Field | Notes |');
                    lines.push('|------|-------|-------|');
                    const fpTablesSeen = new Set();
                    const cgTablesSeen = new Set();
                    for (const f of visual.fields) {
                        const role = this._normalizeRoleForReport(f.projectionName);
                        const tableName = f.table || f.entity || '';
                        const name = f.name || f.column || f.hierarchy || '';
                        let notes = '';
                        const fpItems = this._getFieldParameterItems(tableName);
                        if (fpItems !== null) {
                            notes = `Field Param (${fpItems.length} field${fpItems.length !== 1 ? 's' : ''})`;
                            fpTablesSeen.add(tableName);
                        } else {
                            const cgItems = this._getCalculationGroupItems(tableName);
                            if (cgItems !== null) {
                                notes = `Calc Group (${cgItems.length} item${cgItems.length !== 1 ? 's' : ''})`;
                                cgTablesSeen.add(tableName);
                            }
                        }
                        lines.push(`| ${role} | ${this._escMd(tableName)}[${this._escMd(name)}] | ${notes} |`);
                    }
                    lines.push('');

                    // Field parameter details
                    for (const tbl of fpTablesSeen) {
                        const fpItems = this._getFieldParameterItems(tbl);
                        if (fpItems && fpItems.length > 0) {
                            lines.push(`> **Field Parameter: '${this._escMd(tbl)}'** ‚Äî ${fpItems.length} available field${fpItems.length !== 1 ? 's' : ''}:`);
                            lines.push(`> ${fpItems.map(i => `\`'${i.table}'[${i.column}]\``).join(', ')}`);
                            lines.push('');
                        }
                    }

                    // Calculation group details
                    for (const tbl of cgTablesSeen) {
                        const cgItems = this._getCalculationGroupItems(tbl);
                        if (cgItems && cgItems.length > 0) {
                            lines.push(`> **Calculation Group: '${this._escMd(tbl)}'** ‚Äî ${cgItems.length} item${cgItems.length !== 1 ? 's' : ''}:`);
                            for (const item of cgItems) {
                                lines.push(`> - **${this._escMd(item.name)}**`);
                                if (item.expression) {
                                    lines.push(`>   \`\`\`dax`);
                                    for (const exprLine of item.expression.split('\n')) {
                                        lines.push(`>   ${exprLine}`);
                                    }
                                    lines.push(`>   \`\`\``);
                                }
                            }
                            lines.push('');
                        }
                    }
                } else {
                    lines.push('*No data fields*');
                    lines.push('');
                }
            }
        }
    }

    /**
     * Append visual usage cross-reference summary
     */
    _appendMarkdownVisualUsageSummary(lines) {
        lines.push('## Visual Usage');
        lines.push('');
        lines.push('| Field | Type | Table | Used In |');
        lines.push('|-------|------|-------|---------|');

        for (const [key, usages] of Object.entries(this.visualUsage)) {
            const [type, table, field] = key.split('|');
            const visualList = usages.map(u => `${u.pageName}: ${u.visualName}`).join('; ');
            lines.push(`| ${field} | ${type} | ${table} | ${visualList} |`);
        }
        lines.push('');
    }

    /**
     * Append data lineage sections to markdown
     */
    _appendMarkdownLineageSections(lines, visualData) {
        if (!this.lineageEngine) return;

        // Data Sources section
        const dataSources = this.lineageEngine.getAllDataSources();
        if (dataSources.length > 0) {
            lines.push('## Data Sources');
            lines.push('');
            lines.push('| Type | Server/URL | Database | Parameterized |');
            lines.push('|------|-----------|----------|---------------|');
            for (const src of dataSources) {
                const server = src.serverResolved || src.server || src.url || src.path || '';
                const db = src.databaseResolved || src.database || '';
                lines.push(`| ${src.type} | ${server} | ${db} | ${src.parameterized ? 'Yes' : 'No'} |`);
            }
            lines.push('');
        }

        // Measure Dependencies section
        const allMeasures = [];
        for (const table of this.model.tables) {
            for (const measure of table.measures) {
                const chain = this.lineageEngine.resolveMeasureChain(measure.name);
                if (chain.length > 0) {
                    allMeasures.push({ name: measure.name, table: table.name, chain });
                }
            }
        }
        if (allMeasures.length > 0) {
            lines.push('## Measure Dependencies');
            lines.push('');
            lines.push('| Measure | Table | Depends On |');
            lines.push('|---------|-------|------------|');
            for (const m of allMeasures) {
                const deps = m.chain.map(d => `[${d.name}]`).join(' \u2192 ');
                lines.push(`| ${m.name} | ${m.table} | ${deps} |`);
            }
            lines.push('');
        }

        // Visual Lineage summaries
        if (visualData && visualData.visuals && visualData.visuals.length > 0) {
            lines.push('## Visual Lineage Summary');
            lines.push('');
            lines.push('| Visual | Page | Lineage |');
            lines.push('|--------|------|---------|');
            for (const visual of visualData.visuals) {
                const summary = this.lineageEngine.getLineageSummary(visual.pageName, visual.visualName);
                if (summary) {
                    lines.push(`| ${visual.visualName} | ${visual.pageName} | ${summary} |`);
                }
            }
            lines.push('');
        }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // HTML
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    generateHTML() {
        const modelName = this.model.database?.name || this.model.model?.name || 'Semantic Model';
        const totalMeasures = this.model.tables.reduce((sum, t) => sum + t.measures.length, 0);
        const totalColumns = this.model.tables.reduce((sum, t) => sum + t.columns.length, 0);

        let html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${this._escHtml(modelName)} ‚Äî Documentation</title>
<style>
:root {
    --primary: #1a3a5c;
    --accent: #c89632;
    --bg: #fafaf8;
    --card-bg: #ffffff;
    --border: #e0dcd4;
    --text: #2c2c2c;
    --text-secondary: #666;
    --code-bg: #f5f2ed;
    --measure-bg: #fff8e1;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 24px;
}
h1 { color: var(--primary); font-size: 28px; margin-bottom: 8px; }
h2 {
    color: var(--primary);
    font-size: 22px;
    margin: 40px 0 16px;
    padding-bottom: 8px;
    border-bottom: 3px solid var(--accent);
}
h3 { color: var(--primary); font-size: 18px; margin: 24px 0 12px; }
h4 { color: var(--text); font-size: 15px; margin: 16px 0 8px; }
h5 { color: var(--text-secondary); font-size: 14px; margin: 12px 0 6px; }
.subtitle { color: var(--text-secondary); margin-bottom: 32px; font-size: 14px; }
table {
    width: 100%;
    border-collapse: collapse;
    margin: 12px 0 24px;
    font-size: 14px;
}
th {
    background: var(--primary);
    color: white;
    text-align: left;
    padding: 10px 12px;
    font-weight: 600;
}
td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
}
tr:nth-child(even) { background: #f8f6f2; }
tr:hover { background: #f0ebe3; }
.dax-block {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-left: 4px solid var(--accent);
    padding: 12px 16px;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 13px;
    line-height: 1.5;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-word;
    margin: 8px 0 16px;
    border-radius: 4px;
}
.measure-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin: 12px 0;
}
.measure-card h5 {
    margin: 0 0 8px;
    color: var(--primary);
    font-size: 15px;
}
.measure-meta {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}
.measure-meta span { display: flex; align-items: center; gap: 4px; }
.badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}
.badge-column { background: #e3f2fd; color: #1565c0; }
.badge-measure { background: var(--measure-bg); color: #f57f17; }
.badge-hidden { background: #fce4ec; color: #c62828; }
.badge-active { background: #e8f5e9; color: #2e7d32; }
.badge-inactive { background: #fce4ec; color: #c62828; }
.ref-list {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin: 4px 0;
}
.ref-tag {
    background: #e8eaf6;
    color: #283593;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-family: monospace;
}
.visual-usage {
    background: #f3e5f5;
    border-radius: 4px;
    padding: 8px 12px;
    margin: 4px 0;
    font-size: 13px;
}
.visual-usage strong { color: #6a1b9a; }
blockquote {
    border-left: 4px solid var(--accent);
    padding: 8px 16px;
    margin: 8px 0;
    background: #fffde7;
    color: var(--text-secondary);
    font-style: italic;
}
.toc { columns: 2; margin: 0 0 32px; }
.toc a {
    color: var(--primary);
    text-decoration: none;
    display: block;
    padding: 2px 0;
}
.toc a:hover { text-decoration: underline; }
.overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin: 16px 0;
}
.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
}
.stat-card .stat-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
}
.stat-card .stat-label {
    font-size: 13px;
    color: var(--text-secondary);
}
.rel-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    margin: 6px 0;
    font-size: 14px;
}
.rel-arrow { color: var(--accent); font-weight: 700; font-size: 18px; }
.footer {
    margin-top: 48px;
    padding-top: 16px;
    border-top: 2px solid var(--border);
    text-align: center;
    font-size: 13px;
    color: var(--text-secondary);
}
.footer a { color: var(--primary); }
/* DAX syntax highlighting */
.dax-keyword { color: #0000ff; font-weight: 600; }
.dax-function { color: #795548; }
.dax-string { color: #b71c1c; }
.dax-comment { color: #388e3c; font-style: italic; }
.dax-number { color: #e65100; }
.dax-ref { color: #1565c0; }
@media print {
    body { max-width: 100%; padding: 20px; }
    h2 { page-break-before: always; }
    .measure-card { page-break-inside: avoid; }
}
@media (max-width: 768px) {
    .toc { columns: 1; }
    .overview-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>
<h1>${this._escHtml(modelName)}</h1>
<p class="subtitle">Documentation generated on ${new Date().toLocaleDateString()}</p>
`;

        // Overview
        html += `<h2 id="model-overview">Model Overview</h2>
<div class="overview-grid">
    <div class="stat-card"><div class="stat-value">${this.model.tables.length}</div><div class="stat-label">Tables</div></div>
    <div class="stat-card"><div class="stat-value">${totalColumns}</div><div class="stat-label">Columns</div></div>
    <div class="stat-card"><div class="stat-value">${totalMeasures}</div><div class="stat-label">Measures</div></div>
    <div class="stat-card"><div class="stat-value">${this.model.relationships.length}</div><div class="stat-label">Relationships</div></div>
</div>
<table>
<tr><th>Property</th><th>Value</th></tr>`;

        if (this.model.database?.name) html += `<tr><td>Database</td><td>${this._escHtml(this.model.database.name)}</td></tr>`;
        if (this.model.database?.compatibilityLevel) html += `<tr><td>Compatibility Level</td><td>${this.model.database.compatibilityLevel}</td></tr>`;
        if (this.model.model?.culture) html += `<tr><td>Culture</td><td>${this.model.model.culture}</td></tr>`;

        html += `</table>`;

        // Table of Contents
        html += `<h2>Table of Contents</h2><div class="toc">`;
        for (const table of this.model.tables) {
            const anchor = this._anchor(table.name);
            html += `<a href="#${anchor}">${this._escHtml(table.name)} (${table.columns.length} cols, ${table.measures.length} measures)</a>`;
        }
        html += `</div>`;

        // Tables
        html += `<h2 id="table-inventory">Table Inventory</h2>`;

        for (const table of this.model.tables) {
            html += `<h3 id="${this._anchor(table.name)}">${this._escHtml(table.name)}`;
            if (table.isHidden) html += ` <span class="badge badge-hidden">Hidden</span>`;
            html += `</h3>`;

            if (table.description) {
                html += `<blockquote>${this._escHtml(table.description)}</blockquote>`;
            }

            // Columns
            if (table.columns.length > 0) {
                html += `<h4>Columns (${table.columns.length})</h4>
<table><tr><th>Column</th><th>Data Type</th><th>Description</th><th>Format</th><th>Status</th></tr>`;

                for (const col of table.columns) {
                    html += `<tr>
    <td>${this._escHtml(col.name)}</td>
    <td>${col.dataType || ''}</td>
    <td>${this._escHtml(col.description || '')}</td>
    <td>${this._escHtml(col.formatString || '')}</td>
    <td>${col.isHidden ? '<span class="badge badge-hidden">Hidden</span>' : ''}</td>
</tr>`;
                }
                html += `</table>`;
            }

            // Measures
            if (table.measures.length > 0) {
                html += `<h4>Measures (${table.measures.length})</h4>`;

                for (const measure of table.measures) {
                    html += `<div class="measure-card">
    <h5>${this._escHtml(measure.name)}</h5>`;

                    if (measure.description) {
                        html += `<blockquote>${this._escHtml(measure.description)}</blockquote>`;
                    }

                    html += `<div class="measure-meta">`;
                    if (measure.displayFolder) html += `<span>üìÅ ${this._escHtml(measure.displayFolder)}</span>`;
                    if (measure.formatString) html += `<span>üìê ${this._escHtml(measure.formatString)}</span>`;
                    html += `</div>`;

                    if (measure.expression) {
                        html += `<div class="dax-block">${this._highlightDAX(measure.expression)}</div>`;
                    }

                    // References
                    const refs = this.measureRefs[measure.name];
                    if (refs) {
                        if (refs.columnRefs.length > 0) {
                            html += `<div class="ref-list"><strong>Columns:&nbsp;</strong>`;
                            for (const r of refs.columnRefs) {
                                html += `<span class="ref-tag">${this._escHtml(r.table)}[${this._escHtml(r.column)}]</span>`;
                            }
                            html += `</div>`;
                        }
                        if (refs.measureRefs.length > 0) {
                            html += `<div class="ref-list"><strong>Measures:&nbsp;</strong>`;
                            for (const r of refs.measureRefs) {
                                html += `<span class="ref-tag badge-measure">[${this._escHtml(r)}]</span>`;
                            }
                            html += `</div>`;
                        }
                    }

                    // Visual usage
                    const usageKey = `measure|${table.name}|${measure.name}`;
                    const usage = this.visualUsage[usageKey];
                    if (usage && usage.length > 0) {
                        html += `<div class="visual-usage"><strong>Used in:</strong> `;
                        const byPage = this._groupByPage(usage);
                        const parts = [];
                        for (const [page, visuals] of Object.entries(byPage)) {
                            parts.push(`<em>${this._escHtml(page)}</em>: ${visuals.map(v => this._escHtml(v.visualName)).join(', ')}`);
                        }
                        html += parts.join(' | ');
                        html += `</div>`;
                    }

                    html += `</div>`;
                }
            }
        }

        // Measure Catalog
        html += `<h2 id="measure-catalog">Measure Catalog</h2>
<table><tr><th>#</th><th>Measure</th><th>Table</th><th>Display Folder</th><th>Format</th><th>Description</th></tr>`;

        let num = 0;
        for (const table of this.model.tables) {
            for (const m of table.measures) {
                num++;
                html += `<tr>
    <td>${num}</td>
    <td>${this._escHtml(m.name)}</td>
    <td>${this._escHtml(table.name)}</td>
    <td>${this._escHtml(m.displayFolder || '')}</td>
    <td>${this._escHtml(m.formatString || '')}</td>
    <td>${this._escHtml(m.description || '')}</td>
</tr>`;
            }
        }
        html += `</table>`;

        // Relationships
        html += `<h2 id="relationships">Relationships</h2>`;

        if (this.model.relationships.length > 0) {
            for (const r of this.model.relationships) {
                const statusBadge = r.isActive
                    ? '<span class="badge badge-active">Active</span>'
                    : '<span class="badge badge-inactive">Inactive</span>';
                html += `<div class="rel-card">
    <span>${this._escHtml(r.fromTable)}[${this._escHtml(r.fromColumn)}]</span>
    <span class="rel-arrow">‚Üí</span>
    <span>${this._escHtml(r.toTable)}[${this._escHtml(r.toColumn)}]</span>
    <span class="badge">${this._formatCardinality(r)}</span>
    ${statusBadge}
</div>`;
            }
        } else {
            html += `<p><em>No relationships defined.</em></p>`;
        }

        // Roles
        if (this.model.roles.length > 0) {
            html += `<h2 id="roles">Roles</h2>`;

            for (const role of this.model.roles) {
                html += `<h3>${this._escHtml(role.name)}</h3>`;
                if (role.modelPermission) {
                    html += `<p><strong>Permission:</strong> ${role.modelPermission}</p>`;
                }
                if (role.tablePermissions.length > 0) {
                    html += `<table><tr><th>Table</th><th>Filter Expression</th></tr>`;
                    for (const tp of role.tablePermissions) {
                        html += `<tr><td>${this._escHtml(tp.table)}</td><td><code>${this._escHtml(tp.filterExpression || '')}</code></td></tr>`;
                    }
                    html += `</table>`;
                }
            }
        }

        // Expressions
        if (this.model.expressions.length > 0) {
            html += `<h2 id="expressions">Expressions</h2>`;
            for (const expr of this.model.expressions) {
                html += `<h3>${this._escHtml(expr.name)}</h3>`;
                if (expr.kind) html += `<p><strong>Kind:</strong> ${expr.kind}</p>`;
                if (expr.expression) {
                    html += `<div class="dax-block">${this._escHtml(expr.expression)}</div>`;
                }
            }
        }

        // Footer
        html += `<div class="footer">
    <p>Generated with <a href="https://github.com/JonathanJihwanKim/pbip-documenter" target="_blank">pbip-documenter</a> ‚Äî free, open-source TMDL documentation.</p>
    <p>If this tool saved you time, consider <a href="https://github.com/sponsors/JonathanJihwanKim?o=doc" target="_blank">sponsoring</a> or <a href="https://buymeacoffee.com/jihwankim?o=doc" target="_blank">buying a coffee</a>.</p>
    <p><a href="https://github.com/JonathanJihwanKim/pbip-impact-analyzer" target="_blank">PBIP Impact Analyzer</a> | <a href="https://jonathanjihwankim.github.io/isHiddenInViewMode/" target="_blank">PBIR Visual Manager</a></p>
</div>
</body>
</html>`;

        return html;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // FULL REPORT (comprehensive HTML)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    generateFullReport(visualData, diagramRenderer, scope = 'all') {
        const modelName = this.model.database?.name || this.model.model?.name || 'Semantic Model';
        const totalMeasures = this.model.tables.reduce((sum, t) => sum + t.measures.length, 0);
        const totalColumns = this.model.tables.reduce((sum, t) => sum + t.columns.length, 0);

        // Get relationship diagram SVG
        let relDiagramSVG = '';
        if (diagramRenderer) {
            relDiagramSVG = diagramRenderer.exportSVG() || '';
        }

        let html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${this._escHtml(modelName)} ‚Äî Full Report</title>
<style>
:root {
    --primary: #1a3a5c;
    --accent: #c89632;
    --bg: #fafaf8;
    --card-bg: #ffffff;
    --border: #e0dcd4;
    --text: #2c2c2c;
    --text-secondary: #666;
    --code-bg: #f5f2ed;
    --measure-bg: #fff8e1;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 24px;
}
h1 { color: var(--primary); font-size: 28px; margin-bottom: 8px; }
h2 {
    color: var(--primary);
    font-size: 22px;
    margin: 40px 0 16px;
    padding-bottom: 8px;
    border-bottom: 3px solid var(--accent);
}
h3 { color: var(--primary); font-size: 18px; margin: 24px 0 12px; }
h4 { color: var(--text); font-size: 15px; margin: 16px 0 8px; }
h5 { color: var(--text-secondary); font-size: 14px; margin: 12px 0 6px; }
.subtitle { color: var(--text-secondary); margin-bottom: 32px; font-size: 14px; }
table {
    width: 100%;
    border-collapse: collapse;
    margin: 12px 0 24px;
    font-size: 14px;
}
th {
    background: var(--primary);
    color: white;
    text-align: left;
    padding: 10px 12px;
    font-weight: 600;
}
td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
}
tr:nth-child(even) { background: #f8f6f2; }
tr:hover { background: #f0ebe3; }
.dax-block {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-left: 4px solid var(--accent);
    padding: 12px 16px;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 13px;
    line-height: 1.5;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-word;
    margin: 8px 0 16px;
    border-radius: 4px;
}
.measure-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin: 12px 0;
}
.measure-card h5 {
    margin: 0 0 8px;
    color: var(--primary);
    font-size: 15px;
}
.measure-meta {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}
.badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}
.badge-column { background: #e3f2fd; color: #1565c0; }
.badge-measure { background: var(--measure-bg); color: #f57f17; }
.badge-hidden { background: #fce4ec; color: #c62828; }
.badge-active { background: #e8f5e9; color: #2e7d32; }
.badge-inactive { background: #fce4ec; color: #c62828; }
.badge-visual-type {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    background: #f3e5f5;
    color: #6a1b9a;
}
.ref-list {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin: 4px 0;
}
.ref-tag {
    background: #e8eaf6;
    color: #283593;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-family: monospace;
}
.visual-usage {
    background: #f3e5f5;
    border-radius: 4px;
    padding: 8px 12px;
    margin: 4px 0;
    font-size: 13px;
}
.visual-usage strong { color: #6a1b9a; }
blockquote {
    border-left: 4px solid var(--accent);
    padding: 8px 16px;
    margin: 8px 0;
    background: #fffde7;
    color: var(--text-secondary);
    font-style: italic;
}
.toc { columns: 2; margin: 0 0 32px; }
.toc a {
    color: var(--primary);
    text-decoration: none;
    display: block;
    padding: 2px 0;
}
.toc a:hover { text-decoration: underline; }
.overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin: 16px 0;
}
.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
}
.stat-card .stat-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
}
.stat-card .stat-label {
    font-size: 13px;
    color: var(--text-secondary);
}
.rel-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    margin: 6px 0;
    font-size: 14px;
}
.rel-arrow { color: var(--accent); font-weight: 700; font-size: 18px; }
.page-layout-section {
    background: #f8f8f8;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin: 16px 0;
}
.page-layout-section svg { max-width: 100%; height: auto; }
.visual-card-report {
    background: var(--card-bg);
    border: 1px solid #ce93d8;
    border-left: 4px solid #9c27b0;
    border-radius: 6px;
    padding: 12px 16px;
    margin: 8px 0;
}
.visual-card-report h5 { color: var(--primary); margin: 0 0 6px; }
.field-chip-report {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    margin: 1px;
}
.field-chip-report.values { background: #fff8e1; color: #f57f17; }
.field-chip-report.category { background: #e3f2fd; color: #1565c0; }
.field-chip-report.series { background: #e8f5e9; color: #2e7d32; }
.field-chip-report.filters { background: #fce4ec; color: #c62828; }
.field-chip-report.other { background: #f5f5f5; color: var(--text-secondary); }
.footer {
    margin-top: 48px;
    padding-top: 16px;
    border-top: 2px solid var(--border);
    text-align: center;
    font-size: 13px;
    color: var(--text-secondary);
}
.footer a { color: var(--primary); }
.dax-keyword { color: #0000ff; font-weight: 600; }
.dax-function { color: #795548; }
.dax-string { color: #b71c1c; }
.dax-comment { color: #388e3c; font-style: italic; }
.dax-number { color: #e65100; }
.dax-ref { color: #1565c0; }
details {
    margin: 8px 0;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
}
details summary {
    cursor: pointer;
    padding: 10px 16px;
    background: #f8f6f2;
    font-weight: 600;
    font-size: 14px;
    color: var(--primary);
    list-style: none;
    display: flex;
    align-items: center;
    gap: 8px;
}
details summary::-webkit-details-marker { display: none; }
details summary::before {
    content: '\\25B6';
    font-size: 10px;
    transition: transform 0.2s;
    flex-shrink: 0;
}
details[open] summary::before {
    transform: rotate(90deg);
}
details summary:hover {
    background: #f0ebe3;
}
details > .details-content {
    padding: 12px 16px;
}
.badge-calc { background: #e8f5e9; color: #2e7d32; }
.badge-field-param { background: #e3f2fd; color: #1565c0; }
@media print {
    body { max-width: 100%; padding: 20px; }
    h2 { page-break-before: always; }
    .measure-card, .visual-card-report { page-break-inside: avoid; }
    details { border: none; }
    details[open] > .details-content { padding: 0; }
}
@media (max-width: 768px) {
    .toc { columns: 1; }
    .overview-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>
<h1>${this._escHtml(modelName)} \u2014 ${scope === 'model' ? 'Model Documentation' : scope === 'visuals' ? 'Visual Documentation' : 'Full Report'}</h1>
<p class="subtitle">Comprehensive documentation generated on ${new Date().toLocaleDateString()}</p>
`;

        // Table of Contents
        html += `<h2>Table of Contents</h2><div class="toc">
<a href="#model-overview">Model Overview</a>`;
        if (scope !== 'visuals' && relDiagramSVG) html += `<a href="#relationship-diagram">Relationship Diagram</a>`;
        if (scope !== 'visuals') {
            html += `<a href="#table-inventory">Table Inventory</a>`;
            for (const table of this.model.tables) {
                html += `<a href="#${this._anchor(table.name)}">&nbsp;&nbsp;${this._escHtml(table.name)}</a>`;
            }
            html += `<a href="#measure-catalog">Measure Catalog</a>
<a href="#relationships">Relationships</a>`;
            if (this.model.roles.length > 0) html += `<a href="#roles">Roles</a>`;
            if (this.model.expressions.length > 0) html += `<a href="#expressions">Expressions</a>`;
        }
        if (scope !== 'model' && visualData && visualData.pages.length > 0) {
            html += `<a href="#report-pages">Report Pages &amp; Visual Layout</a>`;
            for (const page of visualData.pages) {
                html += `<a href="#page-${this._anchor(page.displayName)}">&nbsp;&nbsp;${this._escHtml(page.displayName)}</a>`;
            }
        }
        if (scope !== 'model' && Object.keys(this.visualUsage).length > 0) html += `<a href="#visual-usage">Visual Usage</a>`;
        html += `</div>`;

        // Model Overview
        html += `<h2 id="model-overview">Model Overview</h2>
<div class="overview-grid">
    <div class="stat-card"><div class="stat-value">${this.model.tables.length}</div><div class="stat-label">Tables</div></div>
    <div class="stat-card"><div class="stat-value">${totalColumns}</div><div class="stat-label">Columns</div></div>
    <div class="stat-card"><div class="stat-value">${totalMeasures}</div><div class="stat-label">Measures</div></div>
    <div class="stat-card"><div class="stat-value">${this.model.relationships.length}</div><div class="stat-label">Relationships</div></div>`;
        if (visualData) {
            html += `<div class="stat-card"><div class="stat-value">${visualData.pages.length}</div><div class="stat-label">Pages</div></div>
    <div class="stat-card"><div class="stat-value">${visualData.visuals.length}</div><div class="stat-label">Visuals</div></div>`;
        }
        html += `</div>
<table>
<tr><th>Property</th><th>Value</th></tr>`;
        if (this.model.database?.name) html += `<tr><td>Database</td><td>${this._escHtml(this.model.database.name)}</td></tr>`;
        if (this.model.database?.compatibilityLevel) html += `<tr><td>Compatibility Level</td><td>${this.model.database.compatibilityLevel}</td></tr>`;
        if (this.model.model?.culture) html += `<tr><td>Culture</td><td>${this.model.model.culture}</td></tr>`;
        html += `</table>`;

        if (scope !== 'visuals') {

        // Relationship Diagram (embedded SVG)
        if (relDiagramSVG) {
            html += `<h2 id="relationship-diagram">Relationship Diagram</h2>
<div style="overflow-x:auto;margin:16px 0">${relDiagramSVG}</div>`;
        }

        // Table Inventory (same as regular HTML export)
        html += `<h2 id="table-inventory">Table Inventory</h2>`;

        for (const table of this.model.tables) {
            html += `<h3 id="${this._anchor(table.name)}">${this._escHtml(table.name)}`;
            if (table.isHidden) html += ` <span class="badge badge-hidden">Hidden</span>`;
            html += `</h3>`;

            if (table.description) {
                html += `<blockquote>${this._escHtml(table.description)}</blockquote>`;
            }

            // Field parameter detection
            const fpItems = this._getFieldParameterItems(table.name);
            if (fpItems !== null) {
                html += `<p style="margin:8px 0"><span class="badge badge-field-param">Field Parameter</span> This table is a dynamic field selector.</p>`;
                if (fpItems.length > 0) {
                    html += `<div style="margin:8px 0;padding:8px 12px;background:#e3f2fd;border-radius:4px;font-size:13px"><strong>Available fields (${fpItems.length}):</strong><br>`;
                    for (const item of fpItems) {
                        html += `<span style="display:inline-block;background:#fff;border:1px solid #bbdefb;border-radius:3px;padding:1px 6px;margin:2px;font-family:monospace;font-size:12px">'${this._escHtml(item.table)}'[${this._escHtml(item.column)}]</span>`;
                    }
                    html += `</div>`;
                }
            }

            // Calculation Group
            if (table.calculationGroup && table.calculationGroup.items.length > 0) {
                html += `<h4>Calculation Group <span class="badge badge-calc">Calc Group</span></h4>
<p style="font-size:13px;color:var(--text-secondary);margin-bottom:8px">${table.calculationGroup.items.length} calculation item(s)</p>`;
                for (const item of table.calculationGroup.items) {
                    html += `<div class="measure-card">
    <h5>${this._escHtml(item.name)} <span class="badge badge-calc">Calc Item</span></h5>`;
                    if (item.expression) {
                        html += `<details><summary>Expression</summary><div class="details-content">
<div class="dax-block">${this._highlightDAX(item.expression)}</div>
</div></details>`;
                    }
                    html += `</div>`;
                }
            }

            if (table.columns.length > 0) {
                if (table.columns.length > 5) {
                    html += `<details><summary>Columns (${table.columns.length})</summary><div class="details-content">`;
                } else {
                    html += `<h4>Columns (${table.columns.length})</h4>`;
                }
                html += `<table><tr><th>Column</th><th>Data Type</th><th>Description</th><th>Format</th><th>Status</th></tr>`;
                for (const col of table.columns) {
                    html += `<tr>
    <td>${this._escHtml(col.name)}</td>
    <td>${col.dataType || ''}</td>
    <td>${this._escHtml(col.description || '')}</td>
    <td>${this._escHtml(col.formatString || '')}</td>
    <td>${col.isHidden ? '<span class="badge badge-hidden">Hidden</span>' : ''}</td>
</tr>`;
                }
                html += `</table>`;
                if (table.columns.length > 5) {
                    html += `</div></details>`;
                }
            }

            if (table.measures.length > 0) {
                html += `<h4>Measures (${table.measures.length})</h4>`;
                for (const measure of table.measures) {
                    html += `<div class="measure-card">
    <h5>${this._escHtml(measure.name)}</h5>`;
                    if (measure.description) html += `<blockquote>${this._escHtml(measure.description)}</blockquote>`;
                    html += `<div class="measure-meta">`;
                    if (measure.displayFolder) html += `<span>Folder: ${this._escHtml(measure.displayFolder)}</span>`;
                    if (measure.formatString) html += `<span>Format: ${this._escHtml(measure.formatString)}</span>`;
                    html += `</div>`;
                    if (measure.expression) {
                        html += `<details><summary>DAX Expression</summary><div class="details-content">
<div class="dax-block">${this._highlightDAX(measure.expression)}</div>
</div></details>`;
                    }
                    const refs = this.measureRefs[measure.name];
                    if (refs) {
                        if (refs.columnRefs.length > 0) {
                            html += `<div class="ref-list"><strong>Columns:&nbsp;</strong>`;
                            for (const r of refs.columnRefs) html += `<span class="ref-tag">${this._escHtml(r.table)}[${this._escHtml(r.column)}]</span>`;
                            html += `</div>`;
                        }
                        if (refs.measureRefs.length > 0) {
                            html += `<div class="ref-list"><strong>Measures:&nbsp;</strong>`;
                            for (const r of refs.measureRefs) html += `<span class="ref-tag badge-measure">[${this._escHtml(r)}]</span>`;
                            html += `</div>`;
                        }
                    }
                    const usageKey = `measure|${table.name}|${measure.name}`;
                    const usage = this.visualUsage[usageKey];
                    if (usage && usage.length > 0) {
                        html += `<div class="visual-usage"><strong>Used in:</strong> `;
                        const byPage = this._groupByPage(usage);
                        const parts = [];
                        for (const [page, visuals] of Object.entries(byPage)) {
                            parts.push(`<em>${this._escHtml(page)}</em>: ${visuals.map(v => this._escHtml(v.visualName)).join(', ')}`);
                        }
                        html += parts.join(' | ') + `</div>`;
                    }
                    html += `</div>`;
                }
            }
        }

        // Measure Catalog
        html += `<h2 id="measure-catalog">Measure Catalog</h2>
<table><tr><th>#</th><th>Measure</th><th>Table</th><th>Display Folder</th><th>Format</th><th>Description</th></tr>`;
        let num = 0;
        for (const table of this.model.tables) {
            for (const m of table.measures) {
                num++;
                html += `<tr><td>${num}</td><td>${this._escHtml(m.name)}</td><td>${this._escHtml(table.name)}</td><td>${this._escHtml(m.displayFolder || '')}</td><td>${this._escHtml(m.formatString || '')}</td><td>${this._escHtml(m.description || '')}</td></tr>`;
            }
        }
        html += `</table>`;

        // Relationships
        html += `<h2 id="relationships">Relationships</h2>`;
        if (this.model.relationships.length > 0) {
            for (const r of this.model.relationships) {
                const statusBadge = r.isActive
                    ? '<span class="badge badge-active">Active</span>'
                    : '<span class="badge badge-inactive">Inactive</span>';
                html += `<div class="rel-card">
    <span>${this._escHtml(r.fromTable)}[${this._escHtml(r.fromColumn)}]</span>
    <span class="rel-arrow">&rarr;</span>
    <span>${this._escHtml(r.toTable)}[${this._escHtml(r.toColumn)}]</span>
    <span class="badge">${this._formatCardinality(r)}</span>
    ${statusBadge}
</div>`;
            }
        } else {
            html += `<p><em>No relationships defined.</em></p>`;
        }

        // Roles
        if (this.model.roles.length > 0) {
            html += `<h2 id="roles">Roles</h2>`;
            for (const role of this.model.roles) {
                html += `<h3>${this._escHtml(role.name)}</h3>`;
                if (role.modelPermission) html += `<p><strong>Permission:</strong> ${role.modelPermission}</p>`;
                if (role.tablePermissions.length > 0) {
                    html += `<table><tr><th>Table</th><th>Filter Expression</th></tr>`;
                    for (const tp of role.tablePermissions) {
                        html += `<tr><td>${this._escHtml(tp.table)}</td><td><code>${this._escHtml(tp.filterExpression || '')}</code></td></tr>`;
                    }
                    html += `</table>`;
                }
            }
        }

        // Expressions
        if (this.model.expressions.length > 0) {
            html += `<h2 id="expressions">Expressions</h2>`;
            for (const expr of this.model.expressions) {
                html += `<h3>${this._escHtml(expr.name)}</h3>`;
                if (expr.kind) html += `<p><strong>Kind:</strong> ${expr.kind}</p>`;
                if (expr.expression) html += `<div class="dax-block">${this._escHtml(expr.expression)}</div>`;
            }
        }

        } // end: scope !== 'visuals'

        // Report Pages with Layout Diagrams
        if (scope !== 'model' && visualData && visualData.pages.length > 0) {
            html += `<h2 id="report-pages">Report Pages &amp; Visual Layout</h2>`;

            for (const page of visualData.pages) {
                html += `<h3 id="page-${this._anchor(page.displayName)}">${this._escHtml(page.displayName)} <span style="font-weight:400;font-size:14px;color:var(--text-secondary)">(${page.visuals.length} visuals)</span></h3>`;

                // Page layout diagram
                const visualsWithPos = page.visuals.filter(v => v.position && v.position.x != null);
                if (visualsWithPos.length > 0) {
                    const pw = page.pageWidth || 1280;
                    const ph = page.pageHeight || 720;
                    const scale = Math.min(600 / pw, 1);
                    const svgW = Math.round(pw * scale);
                    const svgH = Math.round(ph * scale);

                    const typeColors = {
                        pivotTable: '#1565c0', table: '#1565c0', matrix: '#1565c0',
                        barChart: '#f57f17', columnChart: '#f57f17', clusteredBarChart: '#f57f17',
                        clusteredColumnChart: '#f57f17', stackedBarChart: '#f57f17', stackedColumnChart: '#f57f17',
                        lineChart: '#2e7d32', areaChart: '#2e7d32', lineClusteredColumnComboChart: '#2e7d32',
                        pieChart: '#c62828', donutChart: '#c62828',
                        card: '#6a1b9a', multiRowCard: '#6a1b9a',
                        slicer: '#00695c', map: '#283593', filledMap: '#283593'
                    };

                    let rects = '';
                    for (const v of visualsWithPos) {
                        const p = v.position;
                        const x = Math.round(p.x * scale);
                        const y = Math.round(p.y * scale);
                        const w = Math.round((p.width || 100) * scale);
                        const h = Math.round((p.height || 60) * scale);
                        const color = typeColors[v.visualType] || '#757575';
                        const maxChars = Math.max(3, Math.floor(w / 7));
                        const label = (v.visualName || v.visualType || '').substring(0, maxChars);

                        rects += `<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="2" fill="${color}" fill-opacity="0.12" stroke="${color}" stroke-width="1"/>
<text x="${x + w / 2}" y="${y + h / 2 + 3}" text-anchor="middle" font-size="9" font-family="Segoe UI, sans-serif" fill="${color}">${this._escHtml(label)}</text>`;
                    }

                    html += `<div class="page-layout-section">
<svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" xmlns="http://www.w3.org/2000/svg">
<rect width="${svgW}" height="${svgH}" fill="#f8f8f8" stroke="#ddd" stroke-width="1" rx="2"/>
${rects}
</svg>
</div>`;
                }

                // Visual details (collapsible)
                if (page.visuals.length > 0) {
                    html += `<details><summary>${page.visuals.length} Visual${page.visuals.length !== 1 ? 's' : ''} ‚Äî click to expand details</summary><div class="details-content">`;
                    for (const visual of page.visuals) {
                        const vName = visual.visualName || visual.visualType || 'Visual';
                        html += `<div class="visual-card-report">
<h5>${this._escHtml(vName)} <span class="badge-visual-type">${this._escHtml(visual.visualType || 'unknown')}</span></h5>`;

                        if (visual.fields && visual.fields.length > 0) {
                            const roleGroups = {};
                            const fpTablesSeen = new Set();
                            const cgTablesSeen = new Set();
                            for (const f of visual.fields) {
                                const role = this._normalizeRoleForReport(f.projectionName);
                                if (!roleGroups[role]) roleGroups[role] = [];
                                roleGroups[role].push(f);
                            }
                            for (const [role, fields] of Object.entries(roleGroups)) {
                                const cssClass = role.toLowerCase().replace(/\s+/g, '');
                                html += `<div style="margin:3px 0"><strong style="font-size:11px;color:var(--text-secondary);text-transform:uppercase">${this._escHtml(role)}:</strong> `;
                                for (const f of fields) {
                                    const t = f.table || f.entity || '';
                                    const n = f.name || f.column || f.hierarchy || '';
                                    html += `<span class="field-chip-report ${cssClass}">${this._escHtml(t)}[${this._escHtml(n)}]</span>`;
                                    const fpItems = this._getFieldParameterItems(t);
                                    if (fpItems !== null) {
                                        html += ` <span class="badge" style="background:#e3f2fd;color:#1565c0;font-size:10px">Field Param&thinsp;(${fpItems.length})</span>`;
                                        fpTablesSeen.add(t);
                                    } else {
                                        const cgItems = this._getCalculationGroupItems(t);
                                        if (cgItems !== null) {
                                            html += ` <span class="badge" style="background:#e8f5e9;color:#2e7d32;font-size:10px">Calc Group&thinsp;(${cgItems.length})</span>`;
                                            cgTablesSeen.add(t);
                                        }
                                    }
                                    html += ' ';
                                }
                                html += `</div>`;
                            }

                            // Field parameter detail blocks
                            for (const tbl of fpTablesSeen) {
                                const fpItems = this._getFieldParameterItems(tbl);
                                if (fpItems && fpItems.length > 0) {
                                    html += `<div style="margin:6px 0;padding:6px 10px;background:#e3f2fd;border-left:3px solid #1565c0;border-radius:4px;font-size:12px">
<strong>Field Parameter: '${this._escHtml(tbl)}'</strong> ‚Äî ${fpItems.length} available field${fpItems.length !== 1 ? 's' : ''}:<br>`;
                                    for (const item of fpItems) {
                                        html += `<span style="display:inline-block;background:#fff;border:1px solid #bbdefb;border-radius:3px;padding:1px 6px;margin:2px;font-family:monospace;font-size:11px">'${this._escHtml(item.table)}'[${this._escHtml(item.column)}]</span>`;
                                    }
                                    html += `</div>`;
                                }
                            }

                            // Calculation group detail blocks
                            for (const tbl of cgTablesSeen) {
                                const cgItems = this._getCalculationGroupItems(tbl);
                                if (cgItems && cgItems.length > 0) {
                                    html += `<div style="margin:6px 0;padding:6px 10px;background:#e8f5e9;border-left:3px solid #2e7d32;border-radius:4px;font-size:12px">
<strong>Calculation Group: '${this._escHtml(tbl)}'</strong> ‚Äî ${cgItems.length} item${cgItems.length !== 1 ? 's' : ''}:`;
                                    for (const item of cgItems) {
                                        html += `<div style="margin:4px 0"><span style="display:inline-block;background:#fff;border:1px solid #c8e6c9;border-radius:3px;padding:1px 6px;font-family:monospace;font-size:11px">${this._escHtml(item.name)}</span>`;
                                        if (item.expression) {
                                            html += `<details style="margin-top:2px"><summary style="font-size:11px;color:#555;cursor:pointer">Expression</summary>
<div class="dax-block" style="margin:4px 0;font-size:11px">${this._highlightDAX(item.expression)}</div></details>`;
                                        }
                                        html += `</div>`;
                                    }
                                    html += `</div>`;
                                }
                            }
                        } else {
                            html += `<p style="font-size:12px;color:var(--text-secondary);font-style:italic">No data fields</p>`;
                        }

                        if (visual.position && visual.position.x != null) {
                            html += `<p style="font-size:11px;color:var(--text-secondary);margin-top:4px">Position: x:${visual.position.x}, y:${visual.position.y}, ${visual.position.width || '?'}x${visual.position.height || '?'}</p>`;
                        }

                        html += `</div>`;
                    }
                    html += `</div></details>`;
                }
            }
        }

        // Visual Usage Summary
        if (scope !== 'model' && Object.keys(this.visualUsage).length > 0) {
            html += `<h2 id="visual-usage">Visual Usage Summary</h2>
<table><tr><th>Field</th><th>Type</th><th>Table</th><th>Used In</th></tr>`;
            for (const [key, usages] of Object.entries(this.visualUsage)) {
                const [type, table, field] = key.split('|');
                const visualList = usages.map(u => `${this._escHtml(u.pageName)}: ${this._escHtml(u.visualName)}`).join('; ');
                html += `<tr><td>${this._escHtml(field)}</td><td>${type}</td><td>${this._escHtml(table)}</td><td>${visualList}</td></tr>`;
            }
            html += `</table>`;
        }

        // Data Lineage Section
        if (this.lineageEngine) {
            const dataSources = this.lineageEngine.getAllDataSources();
            if (dataSources.length > 0) {
                html += `<h2 id="data-sources">Data Sources</h2>
<table><tr><th>Type</th><th>Server/URL</th><th>Database</th><th>Parameterized</th></tr>`;
                for (const src of dataSources) {
                    const server = src.serverResolved || src.server || src.url || src.path || '';
                    const db = src.databaseResolved || src.database || '';
                    html += `<tr><td>${this._escHtml(src.type)}</td><td>${this._escHtml(server)}</td><td>${this._escHtml(db)}</td><td>${src.parameterized ? 'Yes' : 'No'}</td></tr>`;
                }
                html += `</table>`;
            }

            // Visual Lineage Summary
            if (scope !== 'model' && visualData && visualData.visuals && visualData.visuals.length > 0) {
                html += `<h2 id="data-lineage">Visual Lineage</h2>
<table><tr><th>Visual</th><th>Page</th><th>Lineage</th></tr>`;
                for (const visual of visualData.visuals) {
                    const summary = this.lineageEngine.getLineageSummary(visual.pageName, visual.visualName);
                    if (summary) {
                        html += `<tr><td>${this._escHtml(visual.visualName)}</td><td>${this._escHtml(visual.pageName)}</td><td>${this._escHtml(summary)}</td></tr>`;
                    }
                }
                html += `</table>`;
            }
        }

        // Footer
        html += `<div class="footer">
    <p>Generated with <a href="https://github.com/JonathanJihwanKim/pbip-documenter" target="_blank">pbip-documenter</a> ‚Äî free, open-source TMDL documentation with visual lineage.</p>
    <p>If this tool saved you time, consider <a href="https://github.com/sponsors/JonathanJihwanKim?o=doc" target="_blank">sponsoring</a> or <a href="https://buymeacoffee.com/jihwankim?o=doc" target="_blank">buying a coffee</a>.</p>
    <p><a href="https://github.com/JonathanJihwanKim/pbip-impact-analyzer" target="_blank">PBIP Impact Analyzer</a> | <a href="https://jonathanjihwankim.github.io/isHiddenInViewMode/" target="_blank">PBIR Visual Manager</a></p>
</div>
</body>
</html>`;

        return html;
    }

    _normalizeRoleForReport(projectionName) {
        if (!projectionName) return 'Other';
        const lower = projectionName.toLowerCase();
        if (lower === 'values' || lower === 'y') return 'Values';
        if (lower === 'category' || lower === 'x' || lower === 'axis' || lower === 'rows' || lower === 'columns') return 'Category';
        if (lower === 'series' || lower === 'legend') return 'Series';
        if (lower === 'filter' || lower === 'filters') return 'Filters';
        if (lower === 'tooltips' || lower === 'tooltip') return 'Tooltips';
        if (lower === 'sort' || lower === 'visualobjects') return 'Other';
        return projectionName.charAt(0).toUpperCase() + projectionName.slice(1);
    }

    /**
     * Returns NAMEOF field items for a field parameter table, or null if not a field parameter.
     * Checks both column expressions and partition sources for NAMEOF/SWITCH patterns.
     * Returns [] if detected as field param (via SWITCH) but no NAMEOF references found.
     */
    _getFieldParameterItems(tableName) {
        const table = this.model.tables.find(t => t.name === tableName);
        if (!table) return null;

        // Collect all expression texts from columns and partitions
        const allExpressions = [];
        for (const col of table.columns) {
            if (col.expression) allExpressions.push(col.expression);
        }
        for (const part of table.partitions) {
            if (part.source) allExpressions.push(part.source);
        }

        const isFieldParam = allExpressions.some(expr => /NAMEOF|SWITCH/i.test(expr));
        if (!isFieldParam) return null;

        const items = [];
        for (const expr of allExpressions) {
            const matches = [...expr.matchAll(/NAMEOF\s*\(\s*'([^']+)'\[([^\]]+)\]\s*\)/gi)];
            for (const m of matches) items.push({ table: m[1], column: m[2] });
        }
        return items;
    }

    /**
     * Returns calculation group items for a table, or null if not a calc group table.
     */
    _getCalculationGroupItems(tableName) {
        const table = this.model.tables.find(t => t.name === tableName);
        if (!table || !table.calculationGroup || table.calculationGroup.items.length === 0) return null;
        return table.calculationGroup.items;
    }

    /**
     * Renders a compact ASCII layout grid of visual positions for Markdown output.
     * Groups visuals into rows by proximity (y within 80px), then sorts by x.
     * Returns a fenced code block string, or null if no positioned visuals.
     */
    _renderAsciiLayout(page) {
        const pw = page.pageWidth || 1280;
        const ph = page.pageHeight || 720;
        const visuals = page.visuals.filter(v => v.position && v.position.x != null);
        if (visuals.length === 0) return null;

        // Sort by y then x
        const sorted = [...visuals].sort((a, b) => {
            const dy = (a.position.y || 0) - (b.position.y || 0);
            if (Math.abs(dy) > 80) return dy;
            return (a.position.x || 0) - (b.position.x || 0);
        });

        // Group into rows (visuals whose y is within 80px of the row's first visual)
        const rows = [];
        for (const v of sorted) {
            const y = v.position.y || 0;
            const lastRow = rows[rows.length - 1];
            if (lastRow && (y - (lastRow[0].position.y || 0)) <= 80) {
                lastRow.push(v);
            } else {
                rows.push([v]);
            }
        }

        const W = 72;
        const SEP = '+' + '-'.repeat(W) + '+';
        const lines = ['```'];
        lines.push(`Page Layout: ${pw} \u00d7 ${ph}`);
        lines.push(SEP);

        for (const row of rows) {
            const colW = Math.max(8, Math.floor(W / row.length));
            let nameLine = '|';
            let sizeLine = '|';
            for (const v of row) {
                const name = v.visualName || v.visualType || 'visual';
                const truncName = name.length > colW - 2 ? name.substring(0, colW - 3) + '\u2026' : name;
                const pos = `${v.position.width || '?'}\u00d7${v.position.height || '?'}`;
                nameLine += (' ' + truncName).padEnd(colW) + '|';
                sizeLine += (' ' + pos).padEnd(colW) + '|';
            }
            lines.push(nameLine);
            lines.push(sizeLine);
            lines.push(SEP);
        }

        lines.push('```');
        return lines.join('\n');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // JSON
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    generateJSON() {
        const totalMeasures = this.model.tables.reduce((sum, t) => sum + t.measures.length, 0);
        const totalColumns = this.model.tables.reduce((sum, t) => sum + t.columns.length, 0);

        const output = {
            _generator: 'pbip-documenter',
            _generated: new Date().toISOString(),
            _url: 'https://github.com/JonathanJihwanKim/pbip-documenter',
            overview: {
                databaseName: this.model.database?.name || null,
                compatibilityLevel: this.model.database?.compatibilityLevel || null,
                culture: this.model.model?.culture || null,
                tableCount: this.model.tables.length,
                columnCount: totalColumns,
                measureCount: totalMeasures,
                relationshipCount: this.model.relationships.length,
                roleCount: this.model.roles.length
            },
            tables: this.model.tables.map(t => ({
                name: t.name,
                description: t.description,
                isHidden: t.isHidden,
                columns: t.columns,
                measures: t.measures.map(m => ({
                    ...m,
                    references: this.measureRefs[m.name] || null,
                    visualUsage: this.visualUsage[`measure|${t.name}|${m.name}`] || []
                })),
                hierarchies: t.hierarchies,
                partitions: t.partitions
            })),
            relationships: this.model.relationships,
            roles: this.model.roles,
            expressions: this.model.expressions,
            visualUsage: this.visualUsage
        };

        return JSON.stringify(output, null, 2);
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // HELPERS
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    _escMd(str) {
        if (!str) return '';
        return str.replace(/\|/g, '\\|').replace(/\n/g, ' ');
    }

    _escHtml(str) {
        if (!str) return '';
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    }

    _anchor(name) {
        return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    }

    _formatCardinality(r) {
        const from = r.fromCardinality || 'many';
        const to = r.toCardinality || 'one';
        return `${from}:${to}`;
    }

    _groupByPage(usages) {
        const byPage = {};
        for (const u of usages) {
            if (!byPage[u.pageName]) byPage[u.pageName] = [];
            byPage[u.pageName].push(u);
        }
        return byPage;
    }

    /**
     * Basic DAX syntax highlighting for HTML output
     */
    _highlightDAX(dax) {
        let html = this._escHtml(dax);

        // Comments (must be first)
        html = html.replace(/(\/\/.*?)(\n|$)/g, '<span class="dax-comment">$1</span>$2');
        html = html.replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="dax-comment">$1</span>');

        // Strings
        html = html.replace(/(&quot;[^&]*?&quot;)/g, '<span class="dax-string">$1</span>');

        // Numbers
        html = html.replace(/\b(\d+\.?\d*)\b/g, '<span class="dax-number">$1</span>');

        // Column/measure references
        html = html.replace(/(\w+|\&#39;[^&]+\&#39;)\[([^\]]+)\]/g, '<span class="dax-ref">$1[$2]</span>');
        html = html.replace(/\[([^\]]+)\]/g, '<span class="dax-ref">[$1]</span>');

        // DAX keywords
        const keywords = ['VAR', 'RETURN', 'IF', 'SWITCH', 'TRUE', 'FALSE', 'BLANK', 'IN', 'NOT', 'AND', 'OR', 'DEFINE', 'EVALUATE', 'ORDER BY', 'ASC', 'DESC'];
        for (const kw of keywords) {
            html = html.replace(new RegExp(`\\b(${kw})\\b`, 'g'), '<span class="dax-keyword">$1</span>');
        }

        // DAX functions
        html = html.replace(/\b([A-Z][A-Z0-9_.]*)\s*\(/g, '<span class="dax-function">$1</span>(');

        return html;
    }
}

// Export
if (typeof module !== 'undefined' && module.exports) {
    module.exports = DocGenerator;
}
